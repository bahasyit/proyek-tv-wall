<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Display Lobi Sekolah (v3.4 - Shield Fix)</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>

    <div id="start-overlay">
        <button id="start-button">KLIK UNTUK MEMULAI DISPLAY</button>
    </div>

    <div class="grid-container">
        
        <div class="grid-item header">
            <h1>Welcome<br>Students</h1>
        </div>

        <div class="grid-item video">
            <div id="youtube-player"></div>
            <video id="hls-player" class="hidden" autoplay muted loop playsinline></video>
            
            <div id="media-shield"></div>
        </div>
        <div class="grid-item antrian">
            <h2>Nomor Antrian</h2>
            <div class="nomor-utama">
                <span id="antrian-kode">...</span>
                <span id="antrian-nomor">...</span>
            </div>
            <div class="nomor-sub" id="antrian-jenis">...</div>
        </div>

        <div class="grid-item jam">
            <span id="jam-digital">00:00:00</span> WIB
        </div>

        <div class="grid-item cuaca">
            <div class="cuaca-lokasi">
                <span>Kota Bekasi</span>
                <strong id="cuaca-deskripsi">Loading...</strong>
            </div>
            <div class="cuaca-suhu-grup">
                <span id="cuaca-suhu">--</span>Â°C
            </div>
            <div class="cuaca-ikon">
                <img id="cuaca-ikon-img" src="" alt="ikon cuaca">
            </div>
        </div>

        <div class="grid-item footer">
            <div class="marquee-wrapper">
                <span id="marquee-content-1">...</span>
                <span id="marquee-content-2">...</span>
            </div>
        </div>
    </div>

    <audio id="bell-sound" src="bell.mp3" preload="auto"></audio>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <script src="https://www.youtube.com/iframe_api"></script>

    <script>
        // --- Bagian 1: KONFIGURASI & VARIABEL ---
        const firebaseConfig = {
          apiKey: "AIzaSyDnl0AJU10tBXze8u4nDdZoaAUFo8ypFiQ",
          authDomain: "project-tv-wall.firebaseapp.com",
          databaseURL: "https://project-tv-wall-default-rtdb.asia-southeast1.firebasedatabase.app",
          projectId: "project-tv-wall",
          storageBucket: "project-tv-wall.firebasestorage.app",
          messagingSenderId: "562728437251",
          appId: "1:562728437251:web:85e9f229b6e4d02b4f7036"
        };
        
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const refAntrian = database.ref('antrian');
        const refConfig = database.ref('config');
        
        let currentDisplayNomor = "";
        let hlsInstance = null;
        let ytPlayer = null; 
        
        const elBellSound = document.getElementById('bell-sound');
        const elKode = document.getElementById('antrian-kode');
        const elNomor = document.getElementById('antrian-nomor');
        const elJenis = document.getElementById('antrian-jenis');
        const elYoutubePlayerDiv = document.getElementById('youtube-player');
        const elHlsPlayer = document.getElementById('hls-player');
        const elMarqueeContent1 = document.getElementById('marquee-content-1');
        const elMarqueeContent2 = document.getElementById('marquee-content-2');
        const elJamDigital = document.getElementById('jam-digital');
        const apiKey = "f8adb77a7650f3cc5547cb447fab0b86";
        const kota = "Bekasi";
        const elCuacaSuhu = document.getElementById('cuaca-suhu');
        const elCuacaDeskripsi = document.getElementById('cuaca-deskripsi');
        const elCuacaIkon = document.getElementById('cuaca-ikon-img');

        // --- Bagian 2: FUNGSI JAM (LENGKAP) ---
        function updateClock() {
            const now = new Date();
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const seconds = String(now.getSeconds()).padStart(2, '0');
            elJamDigital.innerText = `${hours}:${minutes}:${seconds}`;
        }

        // --- Bagian 3: FUNGSI CUACA (LENGKAP) ---
        function fetchWeather() {
            const apiUrl = `https://api.openweathermap.org/data/2.5/weather?q=${kota}&appid=${apiKey}&units=metric&lang=id`;
            fetch(apiUrl)
                .then(response => response.json())
                .then(data => {
                    if (data && data.main) {
                        elCuacaSuhu.innerText = Math.round(data.main.temp);
                        elCuacaDeskripsi.innerText = data.weather[0].description;
                        elCuacaIkon.src = `https://openweathermap.org/img/wn/${data.weather[0].icon}@2x.png`;
                    }
                })
                .catch(error => { elCuacaDeskripsi.innerText = "Gagal memuat"; });
        }
        
        // --- Bagian 4: FUNGSI ANTRIAN (LENGKAP) ---
        function setupAntrianListener() {
            refAntrian.on('value', (snapshot) => {
                const data = snapshot.val();
                if (!data) return; 
                let nomorTigaDigit = String(data.nomor).padStart(3, '0');
                if (currentDisplayNomor !== "" && nomorTigaDigit !== currentDisplayNomor) {
                    elBellSound.volume = 1.0; 
                    elBellSound.currentTime = 0;
                    elBellSound.play();
                }
                currentDisplayNomor = nomorTigaDigit;
                elKode.innerText = data.kode;
                elNomor.innerText = nomorTigaDigit;
                elJenis.innerText = data.jenis;
            });
        }

        // --- Bagian 5: FUNGSI PLAYER (LENGKAP - dengan Slider Volume) ---
        window.onYouTubeIframeAPIReady = function() { }

        function loadYouTubePlayer(sumber, audioLevel) {
            elYoutubePlayerDiv.classList.remove('hidden');
            elHlsPlayer.classList.add('hidden');
            elHlsPlayer.pause();
            if (hlsInstance) hlsInstance.destroy();
            const isMuted = (audioLevel === 0);
            if (ytPlayer === null) {
                ytPlayer = new YT.Player('youtube-player', {
                    height: '100%', width: '100%',
                    playerVars: {
                        'listType': 'playlist', 'list': sumber,
                        'autoplay': 1, 'controls': 0, 'loop': 1,
                        'modestbranding': 1, 'showinfo': 0,
                        'mute': isMuted ? 1 : 0
                    },
                    events: {
                        'onReady': (event) => {
                            if (!isMuted) { event.target.setVolume(audioLevel); }
                        }
                    }
                });
            } else {
                ytPlayer.loadPlaylist({ 'list': sumber, 'listType': 'playlist' });
                if (isMuted) { ytPlayer.mute(); } 
                else { ytPlayer.unMute(); ytPlayer.setVolume(audioLevel); }
            }
        }

        function loadHlsPlayer(sumber, audioLevel) {
            elHlsPlayer.classList.remove('hidden');
            elYoutubePlayerDiv.classList.add('hidden');
            if (ytPlayer) ytPlayer.stopVideo(); 
            elHlsPlayer.muted = (audioLevel === 0);
            elHlsPlayer.volume = audioLevel / 100;
            if (hlsInstance) hlsInstance.destroy();
            if (Hls.isSupported()) {
                hlsInstance = new Hls();
                hlsInstance.loadSource(sumber);
                hlsInstance.attachMedia(elHlsPlayer);
                hlsInstance.on(Hls.Events.MANIFEST_PARSED, () => { elHlsPlayer.play(); });
            }
        }

        // --- Bagian 6: FUNGSI CMS (LENGKAP - dengan Slider Volume) ---
        function setupConfigListener() {
            refConfig.on('value', (snapshot) => {
                const config = snapshot.val();
                if (!config) return; 
                if (config.marquee && config.marquee.teks) {
                    const newText = config.marquee.teks;
                    elMarqueeContent1.innerText = newText;
                    elMarqueeContent2.innerText = newText;
                }
                if (config.media) {
                    const media = config.media;
                    const audioLevel = media.audio || 0; 
                    if (media.tipe === 'youtube') {
                        loadYouTubePlayer(media.sumber, audioLevel);
                    } else if (media.tipe === 'm3u8') {
                        loadHlsPlayer(media.sumber, audioLevel);
                    }
                }
            });
        }

        // --- Bagian 7: TOMBOL START (LENGKAP) ---
        const startButton = document.getElementById('start-button');
        const startOverlay = document.getElementById('start-overlay');
        startButton.onclick = function() {
            startOverlay.style.display = 'none';
            setInterval(updateClock, 1000); updateClock(); 
            fetchWeather(); setInterval(fetchWeather, 1800000); 
            setupAntrianListener();
            setupConfigListener();
        }
    </script>
</body>
</html>