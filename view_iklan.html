<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Display Iklan (v2 - Slideshow)</title>
    <link rel="stylesheet" href="style_iklan.css">
</head>
<body>

    <div class="grid-container">
        
        <div class="grid-item jam">
            <span id="jam-digital">00:00:00</span> WIB
            <div id="antrian-mini">A 001</div>
        </div>

        <div class="grid-item cuaca">
            <div class="cuaca-suhu-grup">
                <span id="cuaca-suhu">--</span>Â°C
            </div>
            <div class="cuaca-ikon">
                <img id="cuaca-ikon-img" src="" alt="ikon cuaca">
            </div>
        </div>

        <div class="grid-item iklan-kiri" id="iklan-kiri">
            </div>

        <div class="grid-item video">
            <div id="youtube-player"></div>
            <video id="hls-player" class="hidden" autoplay muted loop playsinline></video>
            <div id="media-shield"></div>
        </div>
        
        <div class="grid-item iklan-kanan" id="iklan-kanan">
            </div>

        <div class="grid-item footer">
            <div class="marquee-wrapper">
                <span id="marquee-content-1">...</span>
                <span id="marquee-content-2">...</span>
            </div>
        </div>
    </div>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <script src="https://www.youtube.com/iframe_api"></script>

    <script>
        // --- Bagian 1: KONFIGURASI & VARIABEL ---
        const firebaseConfig = {
          apiKey: "AIzaSyDnl0AJU10tBXze8u4nDdZoaAUFo8ypFiQ",
          authDomain: "project-tv-wall.firebaseapp.com",
          databaseURL: "https://project-tv-wall-default-rtdb.asia-southeast1.firebasedatabase.app",
          projectId: "project-tv-wall",
          storageBucket: "project-tv-wall.firebasestorage.app",
          messagingSenderId: "562728437251",
          appId: "1:562728437251:web:85e9f229b6e4d02b4f7036"
        };
        
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const refAntrian = database.ref('antrian');
        const refConfig = database.ref('config');
        
        let hlsInstance = null;
        let ytPlayer = null; 

        // Elemen (BARU)
        const elAntrianMini = document.getElementById('antrian-mini');
        const elJamDigital = document.getElementById('jam-digital');
        const elCuacaSuhu = document.getElementById('cuaca-suhu');
        const elCuacaIkon = document.getElementById('cuaca-ikon-img');
        const elYoutubePlayerDiv = document.getElementById('youtube-player');
        const elHlsPlayer = document.getElementById('hls-player');
        const elMarqueeContent1 = document.getElementById('marquee-content-1');
        const elMarqueeContent2 = document.getElementById('marquee-content-2');
        const elIklanKiri = document.getElementById('iklan-kiri');
        const elIklanKanan = document.getElementById('iklan-kanan');
        let slideInterval = null; 
        
        const apiKey = "f8adb77a7650f3cc5547cb447fab0b86";
        const kota = "Bekasi";

        // --- Bagian 2: FUNGSI JAM & CUACA (LENGKAP) ---
        function updateClock() {
            const now = new Date();
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const seconds = String(now.getSeconds()).padStart(2, '0');
            elJamDigital.innerText = `${hours}:${minutes}:${seconds}`;
        }
        function fetchWeather() {
            const apiUrl = `https://api.openweathermap.org/data/2.5/weather?q=${kota}&appid=${apiKey}&units=metric&lang=id`;
            fetch(apiUrl).then(res => res.json()).then(data => {
                if (data && data.main) {
                    elCuacaSuhu.innerText = Math.round(data.main.temp);
                    elCuacaIkon.src = `https://openweathermap.org/img/wn/${data.weather[0].icon}@2x.png`;
                }
            }).catch(error => console.error('Error cuaca:', error));
        }
        
        // --- Bagian 3: FUNGSI ANTRIAN (LENGKAP - Versi Mini) ---
        function setupAntrianListener() {
            refAntrian.on('value', (snapshot) => {
                const data = snapshot.val();
                if (!data) return; 
                let nomorTigaDigit = String(data.nomor).padStart(3, '0');
                elAntrianMini.innerText = `${data.kode} ${nomorTigaDigit}`;
            });
        }

        // --- Bagian 4: FUNGSI PLAYER (LENGKAP & BENAR) ---
        window.onYouTubeIframeAPIReady = function() { }
        function loadYouTubePlayer(sumber, audioLevel) {
            elYoutubePlayerDiv.classList.remove('hidden');
            elHlsPlayer.classList.add('hidden');
            if (hlsInstance) hlsInstance.destroy();
            const isMuted = (audioLevel === 0);
            if (ytPlayer === null) {
                ytPlayer = new YT.Player('youtube-player', {
                    height: '100%', width: '100%',
                    playerVars: { 'listType': 'playlist', 'list': sumber, 'autoplay': 1, 'controls': 0, 'loop': 1, 'modestbranding': 1, 'showinfo': 0, 'mute': isMuted ? 1 : 0 },
                    events: { 'onReady': (event) => { if (!isMuted) { event.target.setVolume(audioLevel); } } }
                });
            } else {
                ytPlayer.loadPlaylist({ 'list': sumber, 'listType': 'playlist' });
                if (isMuted) { ytPlayer.mute(); } else { ytPlayer.unMute(); ytPlayer.setVolume(audioLevel); }
            }
        }
        function loadHlsPlayer(sumber, audioLevel) {
            elHlsPlayer.classList.remove('hidden');
            elYoutubePlayerDiv.classList.add('hidden');
            if (ytPlayer) ytPlayer.stopVideo(); 
            elHlsPlayer.muted = (audioLevel === 0);
            elHlsPlayer.volume = audioLevel / 100;
            if (hlsInstance) hlsInstance.destroy();
            if (Hls.isSupported()) {
                hlsInstance = new Hls();
                hlsInstance.loadSource(sumber);
                hlsInstance.attachMedia(elHlsPlayer);
                hlsInstance.on(Hls.Events.MANIFEST_PARSED, () => { elHlsPlayer.play(); });
            } else if (elHlsPlayer.canPlayType('application/vnd.apple.mpegurl')) {
                elHlsPlayer.src = sumber;
                elHlsPlayer.play();
            }
        }

        // --- Bagian 5: FUNGSI CMS (Di-upgrade untuk Slideshow) ---
        function setupConfigListener() {
            refConfig.on('value', (snapshot) => {
                const config = snapshot.val();
                if (!config) return; 
                if (config.marquee && config.marquee.teks) {
                    elMarqueeContent1.innerText = config.marquee.teks;
                    elMarqueeContent2.innerText = config.marquee.teks;
                }
                if (config.media) {
                    const media = config.media;
                    const audioLevel = media.audio || 0; 
                    if (media.tipe === 'youtube') {
                        loadYouTubePlayer(media.sumber, audioLevel);
                    } else if (media.tipe === 'm3u8') {
                        loadHlsPlayer(media.sumber, audioLevel);
                    }
                }
                if (config.iklan_slideshow && config.iklan_slideshow.length > 0) {
                    startSlideshow(config.iklan_slideshow);
                } else {
                    stopSlideshow();
                }
            });
        }
        
        // --- Bagian 6: Logika Slideshow Iklan ---
        function startSlideshow(daftarUrl) {
            stopSlideshow(); 
            let slideIndex = 0;
            function gantiSlide() {
                if (daftarUrl.length === 0) return;
                const urlGambar = daftarUrl[slideIndex % daftarUrl.length];
                elIklanKiri.style.backgroundImage = `url(${urlGambar})`;
                elIklanKanan.style.backgroundImage = `url(${urlGambar})`;
                slideIndex++;
            }
            gantiSlide(); 
            slideInterval = setInterval(gantiSlide, 15000); 
        }
        function stopSlideshow() {
            if (slideInterval) {
                clearInterval(slideInterval);
                slideInterval = null;
            }
            elIklanKiri.style.backgroundImage = 'none';
            elIklanKanan.style.backgroundImage = 'none';
        }

        // --- Bagian 7: JALANKAN OTOMATIS (DIPERBAIKI) ---
        
        // 1. Mulai jam
        setInterval(updateClock, 1000); 
        updateClock(); // Jalankan sekali

        // 2. Mulai cuaca
        fetchWeather(); // Jalankan sekali
        setInterval(fetchWeather, 1800000); // Ulangi tiap 30 menit

        // 3. Mulai dengarkan antrian
        setupAntrianListener();
        
        // 4. !! INI DIA PERBAIKANNYA !!
        setupConfigListener();
        
    </script>
</body>
</html>